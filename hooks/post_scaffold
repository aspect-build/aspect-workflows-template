#!/bin/bash

# Boot direnv
eval "$(direnv hook bash)"

# Mark the dir as allowed
direnv allow {{ .ProjectSnake }}

cd {{ .ProjectSnake }}

set -ex

# Set up the bazel_env
bazel build //tools:bazel_env

eval "$(direnv export bash)"

env

echo "$PATH" | tr ':' '\n'

# Format all Starlark files (i.e. BUILD, WORKSPACE, .bzl, or .sky) in this directory recursively
set +o errexit # ignore exit code
buildifier -r .  # Exits nonzero if it makes changes, and we expect that
set -o errexit

# Run the format tool
bazel run //tools/format

# Run the repin tool
bazel run //tools/repin

{{ if .Computed.js }}
which pnpm
pnpm install --lockfile-only
{{ end }}
